{{define "package" (concat service.namespace '.rpc.rest.' (lower-snake rest_resource.name)) ~}}
package {{package}}

import org.springframework.stereotype.Component
import org.springframework.web.reactive.function.client.WebClient
import org.springframework.beans.factory.annotation.Value
import org.springframework.http.HttpHeaders
import org.springframework.http.MediaType
import org.springframework.http.HttpMethod
import java.util.concurrent.CompletableFuture
import java.util.concurrent.Future

{{define 'config_prefix' (concat
  'rest_client.' (lower-snake graphql_type.rest_client_name)
) ~}}
@Component
class {{upper-camel rest_resource.name}}RestResourceClient(
    @Value("{{concat '\${' config_prefix '.base_url}'}}")
    private val baseUrl: String,
    @Value("{{concat '\${' config_prefix '.api_key}'}}")
    private val apiKey: String,
): {{upper-camel rest_resource.name}}RestResource {
    {{#each rest_resource.operations as |operation| ~}}
    override fun {{lower-camel operation.name}}(
        request: {{upper-camel operation.name}}Request
    ): CompletableFuture<{{upper-camel operation.name}}Response> =
        client
        .method(HttpMethod.{{upper-snake operation.method}})
        .uri {
            it
            .path("{{operation.path}}")
            .queryParam("key", apiKey)
            .build(mapOf(
                {{#each operation.path_parameters as |param| ~}}
                "{{lower-camel param.name}}" to request.{{lower-camel param.name}},
                {{/each}}
                {{#each operation.query_parameters as |param| ~}}
                "{{lower-camel param.name}}" to request.{{lower-camel param.name}},
                {{/each}}
            ))
        }
        .retrieve()
        .bodyToMono({{upper-camel operation.name}}Response::class.java)
        .toFuture()
    {{/each}}

    private val client = WebClient.builder()
        .baseUrl(baseUrl)
        .defaultHeader(HttpHeaders.CONTENT_TYPE, MediaType.APPLICATION_JSON_VALUE)
        .build()
}